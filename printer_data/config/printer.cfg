[include printerfiles/chamber_light.cfg]
[include printerfiles/extruder.cfg]
[include printerfiles/fans.cfg]
[include printerfiles/heater_bed.cfg]
[include printerfiles/heater_chamber.cfg]
[include printerfiles/makros.cfg]
[include printerfiles/motion_xy.cfg]
[include printerfiles/motion_z.cfg]
[include mainsail.cfg]
[include K-ShakeTune/*.cfg]
[include reshelper.cfg]

####################################################################
#   ADXL
####################################################################

#[include printerfiles/adxl.cfg]

####################################################################
#   MCUs
####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_34003F001647313234333236-if00
restart_method: command

[mcu octo2]
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_3E004F001050304235343520-if00
restart_method: command

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_AF77CF205154364134202020FF140532-if00
#serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_3A82FBB74E4B333448202020FF0A3211-if00
x_offset: 15.3
y_offset: 15.3
mesh_main_direction: x
mesh_overscan: 5
mesh_runs: 2
speed: 5.0

####################################################################
#   PRINTER
####################################################################

[printer]
kinematics: cartesian
max_velocity: 800
max_accel: 20000
max_z_velocity: 20
max_z_accel: 100
square_corner_velocity: 8.0

####################################################################
#   Homing
####################################################################

[homing_override]
axes: xyz
gcode:
  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}

  {% if home_all or 'X' in params %}
    _HOME_X
  {% endif %}
  
  {% if home_all or 'Y' in params %}
    _HOME_Y
  {% endif %}
  
  {% if home_all or 'Z' in params %}
    SET_KINEMATIC_POSITION Z=10
    G91
    G1 Z+5 F1500
    G90
    G1 X200 Y200 F15000
    G28 Z
    G1 Z10
  {% endif %}

[gcode_macro _HOME_X]
gcode:
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc5160 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_X1 = printer.configfile.settings['tmc5160 stepper_x1'].run_current|float %}
    {% set HOME_CURRENT = 2.0 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_x1 CURRENT={HOME_CURRENT}

    G28 X
    G91
    G1 X-10 F1200
    G4 P1000

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_x1 CURRENT={RUN_CURRENT_X1}

[gcode_macro _HOME_Y]
gcode:
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc5160 stepper_y'].run_current|float %}
    {% set RUN_CURRENT_Y1 = printer.configfile.settings['tmc5160 stepper_y1'].run_current|float %}
    {% set HOME_CURRENT = 2.0 %}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y1 CURRENT={HOME_CURRENT}

    G28 Y
    G91
    G1 Y10 F1200
    G4 P1000
    
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    SET_TMC_CURRENT STEPPER=stepper_y1 CURRENT={RUN_CURRENT_Y1}

[z_tilt_4z]
z_positions:
  -75, -42 # Front Left
  -75, 500  # Rear Left
  522,  500 # Rear Right
  522,  -42  # Front Right
points:
  34.7,  34.7    # Front Left  - 50,  50
  34.7,  334.7   # Rear Left   - 50,  350
  334.7, 334.7   # Rear Right  - 350, 350
  334.7, 34.7    # Front Right - 350, 50
speed: 250
horizontal_move_z: 10.0
retries: 10
retry_tolerance: 0.01

[gcode_macro Z_TILT_ADJUST]
rename_existing: _Z_TILT_ADJUST
gcode:
    _z_tilt_adjust RETRY_TOLERANCE=1
    _z_tilt_adjust HORIZONTAL_MOVE_Z=2
    G28 Z

[bed_mesh]
speed: 250
horizontal_move_z: 15.0
mesh_min: 25, 25    # X20 Y20 (corrected for beacon XY offset + 20mm)
mesh_max: 375, 375  # X280, Y280 (corrected for beacon XY offset + 20mm)
probe_count: 20, 20
fade_start: 0.5
fade_end: 2
split_delta_z: .025
move_check_distance: 5.0
mesh_pps: 2,2
algorithm: bicubic
bicubic_tension: 0.1
zero_reference_position: 200, 200
#adaptive_margin: 5
    
###################################################################
#   InputShaper
###################################################################

#[mcu crampon]
#serial: /dev/serial/by-id/usb-Klipper_stm32l412xx_2D0033000750475531373320-if00

#[adxl345]
#cs_pin: crampon:PA4
#spi_bus: spi1
#spi_speed: 8000000

[resonance_tester]
probe_points: 200, 200, 50
#accel_chip: adxl345
accel_chip: beacon
accel_per_hz: 75

[input_shaper]
smoother_freq_X: 50.8
#shaper_freq_x: 51.6
shaper_type_x: smooth_mzv
#damping_ratio_x: 0.0468

smoother_freq_Y: 51.0
#shaper_freq_y: 51.6
shaper_type_y: smooth_mzv
#damping_ratio_y: 0.051
enabled_extruders: extruder

####################################################################
#   COMMANDS
####################################################################

[force_move]
enable_force_move: true

[exclude_object]

[pause_resume]
recover_velocity: 300.0

[resonance_holder]

####################################################################
#   AUTO TUNE
####################################################################

[autotune_tmc stepper_x]
motor: ldo-42sth48-2504ah
tuning_goal: auto
voltage: 24

[autotune_tmc stepper_y]
motor: ldo-42sth48-2504ah
tuning_goal: auto
voltage: 24

[autotune_tmc stepper_x1]
motor: ldo-42sth48-2504ah
tuning_goal: auto
voltage: 24

[autotune_tmc stepper_y1]
motor: ldo-42sth48-2504ah
tuning_goal: auto
voltage: 24

[autotune_tmc extruder]
motor: ldo-36sth20-1004ahg
tuning_goal: performance
voltage: 24

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.4240486919041229,
#*# 	  1.7727839329362558,
#*# 	  0.8260604230514813,
#*# 	  0.49405562172618356,
#*# 	  0.37666794049311203,
#*# 	  -0.038059841175212585,
#*# 	  -0.3666973893188458,
#*# 	  0.08515070079950007,
#*# 	  0.3395668647843892,
#*# 	  0.08754298502658493
#*# model_domain = 1.7869812600401878e-07,1.927148095377936e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 28.210006
#*# model_offset = 0.18000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.053679, -0.022767, -0.014889, -0.008931, 0.029141, 0.040172, 0.050200, 0.081874, 0.092850, 0.104904, 0.141946, 0.145433, 0.143361, 0.166153, 0.155985, 0.146056, 0.151343, 0.137149, 0.114256, 0.108154
#*# 	  -0.041330, -0.036387, -0.018153, -0.003135, 0.007957, 0.027253, 0.049716, 0.054237, 0.078604, 0.106435, 0.108307, 0.129206, 0.146783, 0.132002, 0.142331, 0.147798, 0.118107, 0.120477, 0.116718, 0.082182
#*# 	  -0.047143, -0.017819, -0.022151, -0.024175, 0.012817, 0.016612, 0.020642, 0.054801, 0.062419, 0.072032, 0.112626, 0.115830, 0.112483, 0.140308, 0.129300, 0.113421, 0.118955, 0.099565, 0.079981, 0.074280
#*# 	  -0.035816, -0.031493, -0.025543, -0.016688, -0.012764, 0.004969, 0.025564, 0.028917, 0.049894, 0.074816, 0.076935, 0.097589, 0.106577, 0.100539, 0.108427, 0.113239, 0.081377, 0.079435, 0.066753, 0.040456
#*# 	  -0.043598, -0.040386, -0.020633, -0.031259, -0.019253, 0.006235, -0.005793, 0.021697, 0.050698, 0.040718, 0.069582, 0.097091, 0.079838, 0.095875, 0.091261, 0.076129, 0.073891, 0.064815, 0.043977, 0.039894
#*# 	  -0.052917, -0.047794, -0.037994, -0.039378, -0.029283, -0.013317, -0.008006, 0.006274, 0.026879, 0.029683, 0.050992, 0.069460, 0.067097, 0.077261, 0.081740, 0.056196, 0.053830, 0.057455, 0.024034, 0.030337
#*# 	  -0.056398, -0.063903, -0.034520, -0.049722, -0.058016, -0.022500, -0.024123, -0.023446, 0.015239, 0.020145, 0.021087, 0.059224, 0.056280, 0.050982, 0.071152, 0.052349, 0.026594, 0.037341, 0.021600, 0.004210
#*# 	  -0.072554, -0.065761, -0.056616, -0.062257, -0.057504, -0.047262, -0.043306, -0.026650, -0.007154, 0.003738, 0.023358, 0.037214, 0.033461, 0.042497, 0.050391, 0.027952, 0.020002, 0.021321, -0.003998, 0.001688
#*# 	  -0.074178, -0.085025, -0.056015, -0.068793, -0.079117, -0.045935, -0.047808, -0.048567, -0.007814, -0.003578, -0.001357, 0.033869, 0.026768, 0.019075, 0.039203, 0.019937, -0.003286, 0.006945, -0.007196, -0.014887
#*# 	  -0.081033, -0.077297, -0.074076, -0.075363, -0.072856, -0.066529, -0.057191, -0.045698, -0.026764, -0.013791, 0.003189, 0.014022, 0.014260, 0.019088, 0.024766, 0.006639, -0.005715, -0.006314, -0.026692, -0.019172
#*# 	  -0.075056, -0.083086, -0.073560, -0.065648, -0.084931, -0.066314, -0.047950, -0.056666, -0.031964, -0.004750, -0.009956, 0.011960, 0.012147, 0.005557, 0.016196, 0.007162, -0.017031, -0.013060, -0.026549, -0.036407
#*# 	  -0.068760, -0.064330, -0.063834, -0.064107, -0.064653, -0.057692, -0.049709, -0.042402, -0.028901, -0.010361, 0.002535, 0.009164, 0.011702, 0.011716, 0.011252, 0.004688, -0.010055, -0.022532, -0.030771, -0.036093
#*# 	  -0.048641, -0.048039, -0.057186, -0.040460, -0.050193, -0.053325, -0.032239, -0.032005, -0.024151, 0.003566, 0.007738, 0.006754, 0.023566, 0.021965, 0.029827, 0.035260, -0.004231, -0.018865, -0.025135, -0.041367
#*# 	  -0.022676, -0.021222, -0.020931, -0.027975, -0.033600, -0.026279, -0.023034, -0.011840, 0.004192, 0.009595, 0.014206, 0.021621, 0.026019, 0.033417, 0.046498, 0.038560, -0.000209, -0.020998, -0.026717, -0.038291
#*# 	  0.009923, 0.009491, -0.002215, 0.004485, -0.006733, -0.010968, 0.004858, 0.008670, 0.011294, 0.026517, 0.025260, 0.024005, 0.043128, 0.065323, 0.087409, 0.052442, 0.002634, -0.017223, -0.024158, -0.035560
#*# 	  0.033601, 0.033527, 0.030914, 0.018972, 0.010675, 0.015399, 0.012963, 0.019160, 0.028227, 0.043952, 0.061985, 0.061547, 0.052467, 0.092577, 0.140044, 0.074655, 0.006475, -0.017700, -0.024592, -0.034843
#*# 	  0.063720, 0.062774, 0.049707, 0.040396, 0.034300, 0.025142, 0.027666, 0.030287, 0.034845, 0.092551, 0.147068, 0.123737, 0.067128, 0.062487, 0.075730, 0.039634, -0.002276, -0.020822, -0.030257, -0.041190
#*# 	  0.088132, 0.089561, 0.082279, 0.060800, 0.052956, 0.052341, 0.042204, 0.039442, 0.053877, 0.107732, 0.192003, 0.157658, 0.071483, 0.039856, 0.033754, 0.015291, -0.008257, -0.023039, -0.033725, -0.047574
#*# 	  0.109551, 0.107372, 0.094344, 0.073192, 0.074569, 0.065608, 0.056944, 0.053225, 0.049332, 0.077232, 0.116497, 0.096288, 0.056868, 0.041776, 0.027814, 0.012402, -0.009096, -0.021287, -0.033312, -0.047718
#*# 	  0.127897, 0.117261, 0.107183, 0.088089, 0.085235, 0.071666, 0.061233, 0.059948, 0.058140, 0.057968, 0.064712, 0.055208, 0.044213, 0.040586, 0.030136, 0.012233, -0.009779, -0.020764, -0.033919, -0.047826
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.1
#*# min_x = 25.0
#*# max_x = 375.0
#*# min_y = 25.0
#*# max_y = 375.0
